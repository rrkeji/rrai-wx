/*
 * Lottiejs For Wechat Mini Program
 * author: lottiejs.com
 */
import {setup, g, restore} from './adapter'
const {window, document, navigator} = g

;'__LOTTIE_CANVAS__'

function loadAnimation(options) {
  ['wrapper', 'container'].forEach(key => {
    if (key in options) {
      throw new Error(`lottiejs-miniapp: 不支持在微信小程序中使用 lottie 的 '${key}' 参数。`)
    }
  })
  if (typeof options.path === 'string' && !/^https?\:\/\//.test(options.path)) {
    throw new Error(`'path' 仅支持http协议。`)
  }
  if (!options.rendererSettings || !options.rendererSettings.context) {
    throw new Error(`参数 'rendererSettings.context' 应当是一个 CanvasRenderingContext2D。`)
  }
  options.renderer = 'canvas'

  const _aniItem = window.lottie.loadAnimation(options)
  // try to fix https://github.com/airbnb/lottie-web/issues/1772
  const originalDestroy = _aniItem.destroy.bind(_aniItem)
  _aniItem.destroy = function () {
    // 恢复到上一次 canvas 的环境，避免当前 canvas 被销毁后导致 lottie-web 内部死锁
    restore()
    if (_aniItem.renderer && !_aniItem.renderer.destroyed) {
      _aniItem.renderer.renderConfig.clearCanvas = false
    }
    originalDestroy()
  }.bind(_aniItem)


  return _aniItem
}

const {freeze, unfreeze} = window.lottie

export {
  setup,
  loadAnimation,
  freeze,
  unfreeze,
}
